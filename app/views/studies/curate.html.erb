<%= render 'header', :study => @study %>



<div style="float:left;width:400px;margin-right:40px;">
  <h2><span id="region_name_plain">Area: <%= @region.name %></span></h2>

  <%= render 'regions/base_form', :region => @region %>

  <button type="button" class="btn btn-primary" onclick="saveRegion();">
    <i class="icon-ok icon-white"></i> Save
  </button>
  <button type="button" class="btn btn-primary" onclick="$('#delete-region-modal').modal('toggle')">
    <i class="icon-trash icon-white"></i> Delete
  </button>
  <span id="save-notice" class="alert success fade" data-alert="alert"></span>
  </div>
  <div style="float:left;width:500px;">
    <div id="map" class="map" style="float:right; width:500; height:350;"></div>
    <button type="button" class="btn btn-primary" onclick="addPoints();">
      <i class="icon-search icon-white"></i> Find
    </button>
    a total of
    <input id="quantity" type="textfield" style="width:50px;" value="<%= @region.locations.length %>" />
    points at least
    <input id="proximity" type="textfield" style="width:50px;" value="50" />
    meters apart.
    <div id="found-id" style="font-size:larger;">Found <strong><%= @region.locations.length %></strong> images.</div>

  </div>
</div>

<div id="delete-region-modal" class="modal hide fade">
  <div class="modal-header">
    <a class="close" data-dismiss="modal" >&times;</a>
    <h3>Are you sure?</h3>
  </div>
  <div class="modal-body" align="left">
    <p>
      Keep in mind:
      <ul>
        <li>Deleting an area is irreversible.</li>
        <li>Any votes referencing images in this area will be lost.</li>
      </ul>
    </p>
  </div>
  <div class="modal-footer">
    <a id="delete_image" class="btn btn-primary cursor" onclick="deleteRegion();">Confirm Delete</a>
    <a class="btn cursor" data-dismiss="modal" id="close_modal">Cancel</a>
  </div>
</div>

<div id="edit-location-modal" class="modal hide fade">
  <div class="modal-header">
    <a class="close" data-dismiss="modal" >&times;</a>
    <h3>Edit Image</h3>
  </div>
  <div class="modal-body" align="center">
    <div id="panorama" style="width:400px;height:300px"></div>
    <p>To edit, rotate to your desired heading by clicking and dragging.</p>
    <div id="panorama-map" style=""></div>
  </div>
  <div class="modal-footer">
    <a id="save_changes" class="btn btn-primary cursor" onclick="curateHandler.updateLocation();">Save Changes</a>
    <a id="delete_image" class="btn cursor" onclick="curateHandler.deleteLocation()">Delete Image</a>
    <a class="btn cursor" data-dismiss="modal" id="close_modal">Close</a>
  </div>
</div>
<fieldset class="clearfix" style="clear:both;margin-top:30px;">
  <legend>Click on an image to rotate or remove it.</legend>
  <div id="images" class="curate thumbs">
  <% @region.locations.order('id desc').each do |location| %>
    <a id="location-<%= location.id %>" class="thumbnail cursor" data-toggle="modal"
       onclick="curateHandler.editLocation('<%= location.id %>', <%= location.latitude %> , <%= location.longitude %>, <%= location.heading %>, <%= location.pitch %>)">
      <img class="img-polaroid" src="http://maps.googleapis.com/maps/api/streetview?size=200x150&location=<%= location.latitude %>,%20<%= location.longitude %>&heading=<%= location.heading %>&pitch=<%= location.pitch %>&sensor=false" />
    </a>
  <% end %>
  </div>
</fieldset>

<div class="modal hide fade" id="delete-location-modal" align="left">
  <div class="modal-header">
    <a class="close" data-dismiss="modal">Ã—</a>
    <h3>Confirm Delete</h3>
  </div>
  <div class="modal-body">
    <p>Are you sure you want to delete this image?</p>
  </div>
  <div class="modal-footer">
    <a href="#" class="btn" data-dismiss="modal" onclick="curateHandler.deleteLocationCancel();">Cancel</a>
    <a id="delete-locatio-confirm" class="btn btn-primary" onclick="curateHandler.deleteLocationConfirm();">Delete Image</a>
  </div>
</div>


<script type="text/javascript">

  // A handler for the curate process
  var curateHandler;
  var polygonHandler;

  window.onload = function () {

    curateHandler = new ss.handler.Curate(
      'edit-location-modal', 'panorama-map', 'panorama',
      'delete-location-modal', 'location-');

    // create polygon path
    var path = new google.maps.MVCArray;
    <% @region.polygon_path.each do |latlng| %>
    path.push(new google.maps.LatLng(<%= latlng[:lat] %>, <%= latlng[:lng] %>));
    <% end %>

    // create polygon locations
    var locations = new google.maps.MVCArray;
    <% @region.locations.each do |location| %>
    locations.push(new google.maps.LatLng(<%= location.latitude %>, <%= location.longitude %>));
    <% end %>

    var center = new google.maps.LatLng(<%= @region.latitude %>, <%= @region.longitude %>);

    polygonHandler = new ss.handler.Polygon('map', center, <%= @region.zoom %>, false, path, locations);
  }

  function addPoints() {

    if (ss.handler.Polygon.editable) {
      polygonHandler.lock();
    }
    var oldLength = ss.handler.Polygon.locations.length;
    polygonHandler.addPoints(
      document.getElementById('quantity').value,
      document.getElementById('proximity').value,
      function() {
        // This should fire periodically
        var newLength = ss.handler.Polygon.locations.length;
        $('#found-id').html('Found <strong>' + newLength + '</strong> images');
      },
      // this should fire every time a point is created
      function(latLng) {

        ss.Location.prototype.create(<%= @region.id %>, latLng.lat(), latLng.lng(), Math.floor(Math.random()*360), 0, function(loc, status, xhr) {

          // We should append a linked image below
          $(
            '<a>',
            {
              id: 'location-' + loc.id,
              class: 'thumbnail cursor new',
              'data-toggle': 'modal',
              onclick: 'curateHandler.editLocation(' + loc.id + ', ' + loc.latitude + ', ' + loc.longitude + ', ' +loc.heading + ', ' + loc.pitch + ');'

            }
          ).html('<img class="img-polaroid" src="http://maps.googleapis.com/maps/api/streetview?size=200x150'
                + '&location=' + loc.latitude + ',%20' + loc.longitude
                + '&heading=' + loc.heading + '&pitch=' + loc.pitch + '&sensor=false" />').prependTo('#images');

        });

      });
  }

  function saveRegion(){
    region = new ss.Region(<%=@region.id%>, $('#region_name').val(), $('#region_description').val());
    region.update(function() {
      $('#edit-region-modal').modal('toggle');
      $('#region-name-plain').html($('#region_name').val());
      $('#save-notice').html('Area Saved');
      $('#save-notice').addClass('in');
    });
  }

  function deleteRegion(){
    region = new ss.Region(<%=@region.id%>);
    region.delete(function() {
      window.location.replace('/studies/<%= @study.slug %>/vote');
    });
  }
</script>

